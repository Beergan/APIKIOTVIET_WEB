@inherits MyWebPage
@using SLK.Common

@functions {
    [Component(
        Type = ComptType.Page_Template,
        ComptName = "en:Personal info template|vi:Mẫu trang hồ sơ cá nhân",
        PathPostfix = "/{0}",
        PageType = "single", NodeType = "profile")]

    public class ViewModel : PageListModel
    {
        public static ViewModel Default => new ViewModel()
        {
            Title = "Nest",
        };

        public VM_Customer Profile { get; set; }

    }/*end_viewmodel*/
    private ViewModel _data;
    private ViewModel Data => _data ?? (_data = ViewModel.Default);
    private MyTranslator Text => new MyTranslator(Data?.Phrases);

}
@{
    if (IsPost)
    {
        Response.ContentType = "application/json";
        if (Request["action"] == "updateProfile")
        {
            string token = Request.Cookies["jwt"].Value.ToString();

            var validated = new JwtHandler().ValidateJWT(token);

            int id = Convert.ToInt32(validated.FindFirst("uid")?.Value);

            int city = Convert.ToInt32(Request["City"]);
            int ward = Convert.ToInt32(Request["Ward"]);

            var cus = Db.Table<PP_Customer>().Where(c => c.Id == id).FirstOrDefault();

            if (cus != null)
            {
                cus.DisplayName = Request["FullName"];
                cus.PhoneNumber = Request["PhoneNumber"];
                cus.Address = Request["Address"];
                cus.Email = Request["Email"];
                cus.City = city;
                cus.Ward = ward;
                Db.Update(cus);
            }

            Response.Write(Json.Encode(new
            {
                success = true,
                message = "Profile update success!!!"
            }));
            return;
        }
    }

    _data = LoadData<ViewModel>(key: $"{LangId}-{FileName}#{NodeSlug}", setup: (model) =>
    {
        model = model ?? new ViewModel();

        var page = Db.GetOne<PP_Page>(PageId);
        if (page == null) return null;

        if (Request.Cookies.Get("jwt") == null)
        {
            Response.Redirect("/dang-ky-dang-nhap");
        }
        else
        {
            string token = Request.Cookies["jwt"].Value.ToString();

            var validated = new JwtHandler().ValidateJWT(token);

            int id = Convert.ToInt32(validated.FindFirst("uid")?.Value);

            model.Profile = Db.Table<PP_Customer>()
                            .Where(x => x.Id == id)
                            .Select(x => new VM_Customer
                            {
                                Username = x.UserId,
                                Email = x.Email,
                                Address = x.Address,
                                City = x.City,
                                Commune = x.Commune,
                                Ward = x.Ward,
                                PhoneNumber = x.PhoneNumber,
                                DisplayName = x.DisplayName
                            }).FirstOrDefault();
        }

        model.Title = page.Title;
        model.MetaDescription = page.MetaDescription;
        model.MetaKeywords = page.MetaKeywords;

        return model;
    });

    Layout = $"~/_layouts/_layout{Root.LayoutId}.cshtml";
    Page.Title = Data.Title;
    Page.Description = Data.MetaDescription;
    Page.Keywords = Data.MetaKeywords;
    Page.IndexPageRunning = true;
}

<main>
    @{
        var profile = Data.Profile;
    }
    <div class="rosie-wrapper">
        <div class="rosie-sidebar">
            <h2>Hello @(profile.DisplayName == null ? "You" : profile.DisplayName)!</h2>
            <ul class="rosie-nav">
                <li><a href="#" class="active">Dashboard</a></li>
                <li><a href="#">Orders</a></li>
                <li><a href="#">Track Your Order</a></li>
                <li><a href="#">My Address</a></li>
                <li><a href="#">Account Details</a></li>
                <li><a href="#">Logout</a></li>
            </ul>
        </div>
        <div class="rosie-content">
            <form class="row g-3 needs-validation" id="profileForm" novalidate>
                <div class="col-md-4">
                    <label for="validationCustom01" class="form-label">Full name</label>
                    <input type="text" class="form-control" id="validationCustom01" value="@profile.DisplayName" name="FullName" required>
                </div>
                <div class="col-md-4">
                    <label for="validationCustom02" class="form-label">Email</label>
                    <input type="text" class="form-control" id="validationCustom02" value="@profile.Email" name="Email" required>
                </div>
                <div class="col-md-4">
                    <label for="validationCustom02" class="form-label">Phone number</label>
                    <input type="text" class="form-control" id="validationCustom02" value="@profile.PhoneNumber" name="PhoneNumber" required>
                </div>
                <div class="col-md-6">
                    <label for="validationCustom03" class="form-label">Address</label>
                    <input type="text" class="form-control" id="validationCustom03" value="@profile.Address" name="Address" required>
                </div>
                <div class="col-md-3">
                    <label for="ddProvince" class="form-label">City</label>
                    <select class="form-select" id="ddProvince" name="City" required>
                        <option selected disabled value="0">Choose City...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="ddWard" class="form-label">Ward</label>
                    <select class="form-select" id="ddWard" name="Ward" required>
                        <option selected disabled value="0">Choose Ward...</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="agree" value="" id="invalidCheck" required>
                        <label class="form-check-label" for="invalidCheck">
                            Agree to terms and conditions
                        </label>
                    </div>
                </div>
                <ul class="errorList"></ul>
                <div class="col-12">
                    <button class="btn btn-primary UpdateProfile" type="submit">Update Profile</button>
                </div>
            </form>
        </div>
    </div>
</main>

@section scripts {
    <script>

        //get API tinh thanh
        $(() => {
            $.get("https://provinces.open-api.vn/api/v2/?depth=2", function (data) {

                data.forEach(function (item) {
                    $('#ddProvince').append(`<option value=${item.code}>${item.name}</option>`);
                })

                $('#ddProvince').on('change', function () {
                    $('#ddWard').html('<option value="0" disabled>Select Ward...</option>');
                    var code = $('#ddProvince :selected').val();
                    if (code == 0) return;
                    var city = data.find(function (item1) {
                        return (item1.code == code) ? item1 : "";
                    })
                    city.wards.forEach(function (item2) {
                        $('#ddWard').append(`<option value="${item2.code}">${item2.name}</option>`);
                    })
                })
            })

            setTimeout(() => {
                $('#ddProvince').val(@(profile.City)).trigger('change');
                $('#ddWard').val(@(profile.Ward)).trigger('change');
            }, 300)
        })

        $('#profileForm').on('submit', function (e) {
            e.preventDefault();
            $('ul.errorList').html('');
            var userForm = {};
            var hasError = false;
            $('#profileForm [name]').each(function () {
                var name = $(this).attr('name');
                if ($(this).is('select')) {
                    var selectedValue = $(this).find('option:selected').val();
                    if (selectedValue == 0) {
                        $('ul.errorList').append(`<li class="text-danger">Please enter your ${name}</li>`);
                        hasError = true;
                    }
                    userForm[name] = selectedValue;
                }
                else if ($(this).is(':checkbox')) {
                    if (!$(this).prop('checked')) {
                        $('ul.errorList').append(`<li class="text-danger">Please agree to terms and conditions</li>`);
                        hasError = true;
                    }
                }
                else {
                    var value = $(this).val();
                    if (!value.trim()) {
                        $('ul.errorList').append(`<li class="text-danger">Please enter your ${name}</li>`);
                        hasError = true;
                    }
                    userForm[name] = value;
                }
            })

            console.log(userForm);
            if (hasError) return;

            else {
                $.ajax({
                    url: '/@NodeSlug/?action=updateProfile',
                    method: 'POST',
                    data: userForm,
                    success: function (res) {
                        if (res.success) {
                            showAlert('success', res.message, 'success');
                        }
                        else {
                            console.log('failed ', res.message);
                        }
                    }, error: function (er) {
                        console.log('error ', er);
                    }
                })
            }
        })

    </script>
}